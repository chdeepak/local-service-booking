name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_KEY: ${{ secrets.EC2_PRIVATE_KEY }}
        run: |
          echo "=========================================="
          echo "Starting EC2 Deployment"
          echo "=========================================="
          
          # Create SSH key file
          echo "üìù Setting up SSH key..."
          mkdir -p ~/.ssh
          echo "$EC2_KEY" > ~/.ssh/ec2_key.pem
          chmod 600 ~/.ssh/ec2_key.pem
          echo "‚úì SSH key created"
          
          # Add EC2 host to known_hosts
          echo "üîë Adding host to known_hosts..."
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts 2>/dev/null || echo "‚ö† ssh-keyscan warning"
          echo "‚úì Host added"
          
          # Test SSH connection
          echo "üß™ Testing SSH connection to $EC2_USER@$EC2_HOST..."
          ssh -i ~/.ssh/ec2_key.pem -o ConnectTimeout=10 $EC2_USER@$EC2_HOST "echo 'SSH OK'" || {
            echo "‚ùå SSH connection failed!"
            exit 1
          }
          echo "‚úì SSH connection successful"
          
          # Deploy script
          echo ""
          echo "=========================================="
          echo "Running deployment on EC2"
          echo "=========================================="
          
          ssh -i ~/.ssh/ec2_key.pem -o ConnectTimeout=10 $EC2_USER@$EC2_HOST << 'EOF'
            set -e
            
            echo "üìç User: $(whoami)"
            echo "üìç Home: $(pwd)"
            
            # Check if directory exists
            if [ -d ~/local-service-booking ]; then
              echo "‚úì App directory exists"
            else
              echo "‚ö† Creating app directory..."
              mkdir -p ~/local-service-booking
            fi
            
            cd ~/local-service-booking
            echo "üìÇ Working directory: $(pwd)"
            
            # Check git repo
            if [ -d .git ]; then
              echo "‚úì Git repo exists - pulling latest"
              git pull origin main || echo "‚ö† Git pull had issues"
            else
              echo "üì• Cloning repository..."
              git clone https://github.com/chdeepak/local-service-booking.git . || echo "‚ö† Clone issues"
            fi
            
            echo "‚úì Code synced"
            echo "üîç Node: $(node --version)"
            echo "üîç npm: $(npm --version)"
            
            echo "üì¶ Installing dependencies..."
            npm ci --omit=dev || { echo "‚ùå npm install failed"; exit 1; }
            echo "‚úì Dependencies OK"
            
            echo "üî® Building..."
            npm run build || { echo "‚ùå Build failed"; exit 1; }
            echo "‚úì Build OK"
            
            echo "üîÑ Restarting service..."
            sudo systemctl restart local-service-booking || { echo "‚ùå Restart failed"; exit 1; }
            echo "‚úì Service restarted"
            
            sleep 2
            echo "üìä Service status:"
            sudo systemctl status local-service-booking --no-pager || true
            
            echo "‚úÖ Deployment successful!"
          EOF
          
          echo ""
          echo "=========================================="
          echo "‚úÖ All done!"
          echo "=========================================="
