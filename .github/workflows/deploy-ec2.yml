name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_KEY: ${{ secrets.EC2_PRIVATE_KEY }}
        run: |
          echo "=========================================="
          echo "Starting EC2 Deployment"
          echo "=========================================="
          
          # Create SSH key file
          echo "üìù Setting up SSH key..."
          mkdir -p ~/.ssh
          
          # Write key with proper formatting
          echo "$EC2_KEY" > ~/.ssh/ec2_key.pem
          
          # Fix potential line ending issues
          dos2unix ~/.ssh/ec2_key.pem 2>/dev/null || sed -i 's/\r$//' ~/.ssh/ec2_key.pem || true
          
          # Set proper permissions
          chmod 600 ~/.ssh/ec2_key.pem
          
          # Validate key format
          if grep -q "BEGIN.*PRIVATE KEY" ~/.ssh/ec2_key.pem; then
            echo "‚úì SSH key format is valid"
          else
            echo "‚ùå SSH key format is invalid!"
            echo "Key content preview:"
            head -1 ~/.ssh/ec2_key.pem
            tail -1 ~/.ssh/ec2_key.pem
            exit 1
          fi
          
          # Check key file size
          KEY_SIZE=$(wc -c < ~/.ssh/ec2_key.pem)
          echo "‚úì SSH key size: $KEY_SIZE bytes"
          
          if [ $KEY_SIZE -lt 100 ]; then
            echo "‚ùå Key is too small - likely incomplete!"
            exit 1
          fi
          
          # Add EC2 host to known_hosts
          echo "üîë Adding host to known_hosts..."
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts 2>/dev/null || echo "‚ö† ssh-keyscan warning"
          echo "‚úì Host added"
          
          # Test SSH connection
          echo "üß™ Testing SSH connection to $EC2_USER@$EC2_HOST..."
          ssh -v -i ~/.ssh/ec2_key.pem -o ConnectTimeout=10 -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST "echo 'SSH OK'" || {
            echo "‚ùå SSH connection failed!"
            exit 1
          }
          echo "‚úì SSH connection successful"
          
          # Deploy script
          echo ""
          echo "=========================================="
          echo "Running deployment on EC2"
          echo "=========================================="
          
          ssh -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST << 'EOF'
            set -e
            
            echo "=========================================="
            echo "Step 1: Initial Setup (if needed)"
            echo "=========================================="
            
            # Detect OS
            if [ -f /etc/os-release ]; then
              . /etc/os-release
              OS=$ID
            fi
            
            echo "üîç Detected OS: $OS"
            
            # Check if Node.js is installed
            if ! command -v node &> /dev/null; then
              echo "‚ö† Node.js not found - installing..."
              
              if [ "$OS" = "amzn" ]; then
                # Amazon Linux
                echo "üì¶ Installing Node.js on Amazon Linux..."
                curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
                sudo yum install -y nodejs
              elif [ "$OS" = "ubuntu" ] || [ "$OS" = "debian" ]; then
                # Ubuntu/Debian
                echo "üì¶ Installing Node.js on Debian/Ubuntu..."
                curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
                sudo apt-get install -y nodejs
              else
                echo "‚ö† Unknown OS: $OS - attempting generic installation..."
                curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash - || curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              fi
              
              echo "‚úì Node.js installed: $(node --version)"
            else
              echo "‚úì Node.js already installed: $(node --version)"
            fi
            
            # Check if Nginx is installed
            if ! command -v nginx &> /dev/null; then
              echo "‚ö† Nginx not found - installing..."
              
              if [ "$OS" = "amzn" ]; then
                sudo yum install -y nginx
              else
                sudo apt-get update
                sudo apt-get install -y nginx
              fi
              
              echo "‚úì Nginx installed"
            else
              echo "‚úì Nginx already installed"
            fi
            
            # Check if Git is installed
            if ! command -v git &> /dev/null; then
              echo "‚ö† Git not found - installing..."
              
              if [ "$OS" = "amzn" ]; then
                sudo yum install -y git
              else
                sudo apt-get install -y git
              fi
              
              echo "‚úì Git installed"
            else
              echo "‚úì Git already installed"
            fi
            
            echo ""
            echo "=========================================="
            echo "Step 2: Deploy Application"
            echo "=========================================="
            
            echo "üìç User: $(whoami)"
            echo "üìç Home: $(pwd)"
            
            # Check if directory exists
            if [ -d ~/local-service-booking ]; then
              echo "‚úì App directory exists"
            else
              echo "‚ö† Creating app directory..."
              mkdir -p ~/local-service-booking
            fi
            
            cd ~/local-service-booking
            echo "üìÇ Working directory: $(pwd)"
            
            # Check git repo
            if [ -d .git ]; then
              echo "‚úì Git repo exists - pulling latest"
              git pull origin main || echo "‚ö† Git pull had issues"
            else
              echo "üì• Cloning repository..."
              git clone https://github.com/chdeepak/local-service-booking.git . || echo "‚ö† Clone issues"
            fi
            
            echo "‚úì Code synced"
            echo "üîç Node: $(node --version)"
            echo "üîç npm: $(npm --version)"
            
            echo "üì¶ Installing dependencies..."
            npm ci --omit=dev || { echo "‚ùå npm install failed"; exit 1; }
            echo "‚úì Dependencies OK"
            
            echo "üî® Building..."
            npm run build || { echo "‚ùå Build failed"; exit 1; }
            echo "‚úì Build OK"
            
            echo ""
            echo "=========================================="
            echo "Step 3: Configure Systemd Service"
            echo "=========================================="
            
            # Copy systemd service file
            if [ -f /etc/systemd/system/local-service-booking.service ]; then
              echo "‚úì Service file already exists"
            else
              echo "üìã Creating systemd service..."
              sudo cp ~/local-service-booking/scripts/local-service-booking.service /etc/systemd/system/
              sudo systemctl daemon-reload
              sudo systemctl enable local-service-booking
              echo "‚úì Service configured"
            fi
            
            echo ""
            echo "=========================================="
            echo "Step 4: Configure Nginx"
            echo "=========================================="
            
            # Configure Nginx
            if [ -f /etc/nginx/sites-available/local-service-booking ]; then
              echo "‚úì Nginx config already exists"
            else
              echo "üåê Configuring Nginx..."
              sudo cp ~/local-service-booking/scripts/nginx-config.conf /etc/nginx/sites-available/local-service-booking
              sudo ln -sf /etc/nginx/sites-available/local-service-booking /etc/nginx/sites-enabled/
              sudo rm -f /etc/nginx/sites-enabled/default
              sudo nginx -t
              echo "‚úì Nginx configured"
            fi
            
            echo ""
            echo "=========================================="
            echo "Step 5: Start Services"
            echo "=========================================="
            
            echo "üîÑ Restarting application service..."
            sudo systemctl restart local-service-booking || { echo "‚ùå App restart failed"; exit 1; }
            echo "‚úì App service restarted"
            
            echo "üîÑ Restarting Nginx..."
            sudo systemctl restart nginx || { echo "‚ùå Nginx restart failed"; exit 1; }
            echo "‚úì Nginx restarted"
            
            sleep 2
            echo ""
            echo "üìä App Service Status:"
            sudo systemctl status local-service-booking --no-pager || true
            
            echo ""
            echo "üìä Nginx Status:"
            sudo systemctl status nginx --no-pager || true
            
            echo ""
            echo "üß™ Testing health endpoint..."
            curl -s http://localhost:3000/health || echo "‚ö† Direct health check failed, but Nginx should forward it"
            
            echo ""
            echo "‚úÖ Deployment successful!"
          EOF
          
          echo ""
          echo "=========================================="
          echo "‚úÖ All done!"
          echo "=========================================="
